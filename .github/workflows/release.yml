name: Release Build & Deploy

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.1)"
        required: true
        type: string
      deploy_android:
        description: "Deploy Android build to Google Play"
        required: true
        type: boolean
        default: true
      track:
        description: "Google Play track"
        required: true
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
        default: internal

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      release-id: ${{ steps.create-release.outputs.id }}
      upload-url: ${{ steps.create-release.outputs.upload_url }}
      release-tag: ${{ steps.version.outputs.version }}
      release-name: ${{ steps.normalized-version.outputs.value }}
      android-version-code: ${{ steps.android-version-code.outputs.code }}
      deploy-android: ${{ steps.release-settings.outputs.deploy_android }}
      play-track: ${{ steps.release-settings.outputs.play_track }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      - name: Normalize version string
        id: normalized-version
        run: |
          RAW_VERSION="${{ steps.version.outputs.version }}"
          if [ -z "$RAW_VERSION" ]; then
            echo "value=1.0.0" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          CLEANED="${RAW_VERSION#v}"
          if [ -z "$CLEANED" ]; then
            CLEANED="$RAW_VERSION"
          fi
          CLEANED=$(echo "$CLEANED" | tr -d '[:space:]')
          if [ -z "$CLEANED" ]; then
            CLEANED="1.0.0"
          fi
          echo "value=$CLEANED" >> "$GITHUB_OUTPUT"

      - name: Compute Android version code
        id: android-version-code
        run: |
          VERSION_NAME="${{ steps.normalized-version.outputs.value }}"
          CORE_VERSION="${VERSION_NAME%%+*}"
          CORE_VERSION="${CORE_VERSION%%-*}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CORE_VERSION"
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          BASE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          ATTEMPT="${GITHUB_RUN_ATTEMPT:-1}"
          if [ -z "$ATTEMPT" ]; then
            ATTEMPT=1
          fi
          if [ "$ATTEMPT" -gt 99 ]; then
            ATTEMPT=$((ATTEMPT % 100))
            if [ "$ATTEMPT" -eq 0 ]; then
              ATTEMPT=1
            fi
          fi
          VERSION_CODE=$((BASE * 100 + ATTEMPT))
          echo "code=$VERSION_CODE" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        run: |
          echo "## Changes" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> CHANGELOG.md || echo "- Initial release" >> CHANGELOG.md

      - name: Create or reuse Release
        id: create-release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs')
            const tag = `${{ steps.version.outputs.version }}`
            const releaseName = `sushi - SSH client ${tag}`
            const body = fs.readFileSync('CHANGELOG.md', 'utf8')

            let release
            try {
              release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag
              })
              core.info(`Reusing existing release for tag ${tag}`)
            } catch (error) {
              if (error.status !== 404) {
                throw error
              }

              release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: releaseName,
                body,
                draft: false,
                prerelease: false
              })
              core.info(`Created release for tag ${tag}`)
            }

            core.setOutput('id', String(release.data.id))
            core.setOutput('upload_url', release.data.upload_url)

      - name: Determine deployment settings
        id: release-settings
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            DEPLOY_ANDROID="${{ github.event.inputs.deploy_android }}"
            PLAY_TRACK="${{ github.event.inputs.track }}"
            if [ -z "$DEPLOY_ANDROID" ]; then DEPLOY_ANDROID="true"; fi
            if [ -z "$PLAY_TRACK" ]; then PLAY_TRACK="internal"; fi
          else
            DEPLOY_ANDROID="true"
            PLAY_TRACK="internal"
          fi

          echo "deploy_android=$DEPLOY_ANDROID" >> "$GITHUB_OUTPUT"
          echo "play_track=$PLAY_TRACK" >> "$GITHUB_OUTPUT"

  build-android:
    name: Build Android Release
    runs-on: ubuntu-latest
    needs: create-release
    env:
      GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
      RELEASE_VERSION_NAME: ${{ needs.create-release.outputs.release-name }}
      ANDROID_VERSION_CODE: ${{ needs.create-release.outputs.android-version-code }}
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK (API 36)
        run: |
          sdkmanager "platforms;android-36"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Android signing (if keystore available)
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > ${{ github.workspace }}/keystore.jks
          echo "ANDROID_KEYSTORE_PATH=${{ github.workspace }}/keystore.jks" >> $GITHUB_ENV

      - name: Build Android App Bundle
        run: |
          if [ -z "$RELEASE_VERSION_NAME" ]; then
            echo "RELEASE_VERSION_NAME was not provided" >&2
            exit 1
          fi
          if [ -z "$ANDROID_VERSION_CODE" ]; then
            echo "ANDROID_VERSION_CODE was not provided" >&2
            exit 1
          fi

          ./gradlew bundleRelease \
            -PversionName="$RELEASE_VERSION_NAME" \
            -PversionCode="$ANDROID_VERSION_CODE"

      - name: Upload App Bundle to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload-url }}
          asset_path: app/build/outputs/bundle/release/app-release.aab
          asset_name: sushi-ssh-client-android.aab
          asset_content_type: application/octet-stream

      - name: Upload to Google Play
        if: ${{ needs.create-release.outputs.deploy-android == 'true' && env.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON != '' }}
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ env.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: net.hlan.sushi
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          mappingFile: app/build/outputs/mapping/release/mapping.txt
          track: ${{ needs.create-release.outputs.play-track }}
          status: completed
